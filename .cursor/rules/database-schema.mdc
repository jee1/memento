---
globs: *.sql,*.ts
description: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ê·œì¹™
---

# ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê·œì¹™

## ğŸ“‹ M1 (SQLite) ìŠ¤í‚¤ë§ˆ

### ë©”ì¸ í…Œì´ë¸”
```sql
-- ê¸°ì–µ ì•„ì´í…œ í…Œì´ë¸”
CREATE TABLE memory_item (
  id TEXT PRIMARY KEY,
  type TEXT CHECK (type IN ('working','episodic','semantic','procedural')),
  content TEXT NOT NULL,
  importance REAL CHECK (importance >= 0 AND importance <= 1) DEFAULT 0.5,
  privacy_scope TEXT CHECK (privacy_scope IN ('private','team','public')) DEFAULT 'private',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_accessed TIMESTAMP,
  pinned BOOLEAN DEFAULT FALSE,
  source TEXT,
  agent_id TEXT,
  user_id TEXT,
  project_id TEXT,
  origin_trace TEXT -- JSON í˜•íƒœ
);

-- ì„ë² ë”© í…Œì´ë¸”
CREATE TABLE memory_embedding (
  memory_id TEXT PRIMARY KEY,
  embedding BLOB, -- ë²¡í„° ë°ì´í„°
  dim INTEGER NOT NULL,
  FOREIGN KEY (memory_id) REFERENCES memory_item(id) ON DELETE CASCADE
);

-- íƒœê·¸ í…Œì´ë¸” (N:N ê´€ê³„)
CREATE TABLE memory_tag (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE NOT NULL
);

-- ê¸°ì–µ-íƒœê·¸ ê´€ê³„ í…Œì´ë¸”
CREATE TABLE memory_item_tag (
  memory_id TEXT,
  tag_id INTEGER,
  PRIMARY KEY (memory_id, tag_id),
  FOREIGN KEY (memory_id) REFERENCES memory_item(id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES memory_tag(id) ON DELETE CASCADE
);

-- ê¸°ì–µ ê°„ ê´€ê³„ í…Œì´ë¸”
CREATE TABLE memory_link (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  source_id TEXT NOT NULL,
  target_id TEXT NOT NULL,
  relation_type TEXT CHECK (relation_type IN ('cause_of', 'derived_from', 'duplicates', 'contradicts')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (source_id) REFERENCES memory_item(id) ON DELETE CASCADE,
  FOREIGN KEY (target_id) REFERENCES memory_item(id) ON DELETE CASCADE
);

-- í”¼ë“œë°± ì´ë²¤íŠ¸ í…Œì´ë¸”
CREATE TABLE feedback_event (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  memory_id TEXT NOT NULL,
  event_type TEXT CHECK (event_type IN ('used', 'edited', 'neglected', 'helpful', 'not_helpful')),
  score REAL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (memory_id) REFERENCES memory_item(id) ON DELETE CASCADE
);

-- ì‘ì—…ê¸°ì–µ ë²„í¼ í…Œì´ë¸”
CREATE TABLE wm_buffer (
  session_id TEXT PRIMARY KEY,
  items TEXT NOT NULL, -- JSON í˜•íƒœ
  token_budget INTEGER DEFAULT 4000,
  expires_at TIMESTAMP NOT NULL
);
```

### ì¸ë±ìŠ¤ ì„¤ì •
```sql
-- FTS5 í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì¸ë±ìŠ¤
CREATE VIRTUAL TABLE memory_item_fts USING fts5(
  content,
  content='memory_item',
  content_rowid='rowid'
);

-- VSS ë²¡í„° ê²€ìƒ‰ ì¸ë±ìŠ¤ (1536ì°¨ì›)
CREATE VIRTUAL TABLE memory_item_vss USING vss0(
  embedding(1536)
);

-- ì¼ë°˜ ì¸ë±ìŠ¤
CREATE INDEX idx_memory_item_type ON memory_item(type);
CREATE INDEX idx_memory_item_created_at ON memory_item(created_at);
CREATE INDEX idx_memory_item_last_accessed ON memory_item(last_accessed);
CREATE INDEX idx_memory_item_importance ON memory_item(importance);
CREATE INDEX idx_memory_item_pinned ON memory_item(pinned);
CREATE INDEX idx_memory_item_user_id ON memory_item(user_id);
CREATE INDEX idx_memory_item_project_id ON memory_item(project_id);
```

## ğŸ“‹ M3+ (PostgreSQL) ìŠ¤í‚¤ë§ˆ

### ë©”ì¸ í…Œì´ë¸”
```sql
-- ê¸°ì–µ ì•„ì´í…œ í…Œì´ë¸”
CREATE TABLE memory_item (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type TEXT CHECK (type IN ('working','episodic','semantic','procedural')),
  content TEXT NOT NULL,
  importance REAL CHECK (importance >= 0 AND importance <= 1) DEFAULT 0.5,
  privacy_scope TEXT CHECK (privacy_scope IN ('private','team','public')) DEFAULT 'private',
  created_at TIMESTAMPTZ DEFAULT now(),
  last_accessed TIMESTAMPTZ,
  pinned BOOLEAN DEFAULT FALSE,
  source TEXT,
  agent_id TEXT,
  user_id TEXT NOT NULL,
  project_id TEXT,
  origin_trace JSONB,
  -- ìë™ ìƒì„± ì»¬ëŸ¼
  content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('english', content)) STORED
);

-- ì„ë² ë”© í…Œì´ë¸” (pgvector ì‚¬ìš©)
CREATE TABLE memory_embedding (
  memory_id UUID PRIMARY KEY,
  embedding vector(1536), -- pgvector í™•ì¥
  FOREIGN KEY (memory_id) REFERENCES memory_item(id) ON DELETE CASCADE
);

-- íƒœê·¸ í…Œì´ë¸”
CREATE TABLE memory_tag (
  id SERIAL PRIMARY KEY,
  name TEXT UNIQUE NOT NULL
);

-- ê¸°ì–µ-íƒœê·¸ ê´€ê³„ í…Œì´ë¸”
CREATE TABLE memory_item_tag (
  memory_id UUID,
  tag_id INTEGER,
  PRIMARY KEY (memory_id, tag_id),
  FOREIGN KEY (memory_id) REFERENCES memory_item(id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES memory_tag(id) ON DELETE CASCADE
);

-- ê¸°ì–µ ê°„ ê´€ê³„ í…Œì´ë¸”
CREATE TABLE memory_link (
  id SERIAL PRIMARY KEY,
  source_id UUID NOT NULL,
  target_id UUID NOT NULL,
  relation_type TEXT CHECK (relation_type IN ('cause_of', 'derived_from', 'duplicates', 'contradicts')),
  created_at TIMESTAMPTZ DEFAULT now(),
  FOREIGN KEY (source_id) REFERENCES memory_item(id) ON DELETE CASCADE,
  FOREIGN KEY (target_id) REFERENCES memory_item(id) ON DELETE CASCADE
);

-- í”¼ë“œë°± ì´ë²¤íŠ¸ í…Œì´ë¸”
CREATE TABLE feedback_event (
  id SERIAL PRIMARY KEY,
  memory_id UUID NOT NULL,
  event_type TEXT CHECK (event_type IN ('used', 'edited', 'neglected', 'helpful', 'not_helpful')),
  score REAL,
  created_at TIMESTAMPTZ DEFAULT now(),
  FOREIGN KEY (memory_id) REFERENCES memory_item(id) ON DELETE CASCADE
);

-- ì‘ì—…ê¸°ì–µ ë²„í¼ í…Œì´ë¸”
CREATE TABLE wm_buffer (
  session_id TEXT PRIMARY KEY,
  items JSONB NOT NULL,
  token_budget INTEGER DEFAULT 4000,
  expires_at TIMESTAMPTZ NOT NULL
);
```

### ì¸ë±ìŠ¤ ì„¤ì •
```sql
-- pgvector ì¸ë±ìŠ¤
CREATE INDEX ON memory_embedding USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

-- GIN ì¸ë±ìŠ¤ (tsvector)
CREATE INDEX ON memory_item USING GIN (content_tsv);

-- ì¼ë°˜ ì¸ë±ìŠ¤
CREATE INDEX idx_memory_item_type ON memory_item(type);
CREATE INDEX idx_memory_item_created_at ON memory_item(created_at);
CREATE INDEX idx_memory_item_last_accessed ON memory_item(last_accessed);
CREATE INDEX idx_memory_item_importance ON memory_item(importance);
CREATE INDEX idx_memory_item_pinned ON memory_item(pinned);
CREATE INDEX idx_memory_item_user_id ON memory_item(user_id);
CREATE INDEX idx_memory_item_project_id ON memory_item(project_id);

-- ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_memory_item_user_type ON memory_item(user_id, type);
CREATE INDEX idx_memory_item_project_type ON memory_item(project_id, type);
CREATE INDEX idx_memory_item_created_type ON memory_item(created_at, type);
```

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

### SQLite â†’ PostgreSQL ë§ˆì´ê·¸ë ˆì´ì…˜
```typescript
class DatabaseMigrator {
  async migrateFromSQLite(sqlitePath: string, postgresUrl: string): Promise<void> {
    // 1. SQLiteì—ì„œ ë°ì´í„° ì¶”ì¶œ
    const sqliteData = await this.extractSQLiteData(sqlitePath);
    
    // 2. PostgreSQL ìŠ¤í‚¤ë§ˆ ìƒì„±
    await this.createPostgreSQLSchema(postgresUrl);
    
    // 3. ë°ì´í„° ë³€í™˜ ë° ì‚½ì…
    await this.transformAndInsertData(sqliteData, postgresUrl);
    
    // 4. ì„ë² ë”© ì¬ê³„ì‚°
    await this.recalculateEmbeddings(postgresUrl);
  }
  
  private async extractSQLiteData(sqlitePath: string): Promise<any> {
    // SQLite ë°ì´í„° ì¶”ì¶œ ë¡œì§
  }
  
  private async createPostgreSQLSchema(postgresUrl: string): Promise<void> {
    // PostgreSQL ìŠ¤í‚¤ë§ˆ ìƒì„± ë¡œì§
  }
  
  private async transformAndInsertData(data: any, postgresUrl: string): Promise<void> {
    // ë°ì´í„° ë³€í™˜ ë° ì‚½ì… ë¡œì§
  }
  
  private async recalculateEmbeddings(postgresUrl: string): Promise<void> {
    // ì„ë² ë”© ì¬ê³„ì‚° ë¡œì§
  }
}
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
```sql
-- 1. SQLite ë°ì´í„° ì¶”ì¶œ
.mode csv
.headers on
.output memory_items.csv
SELECT * FROM memory_item;

-- 2. PostgreSQL ë°ì´í„° ì‚½ì…
\copy memory_item FROM 'memory_items.csv' WITH CSV HEADER;

-- 3. ì„ë² ë”© ì¬ê³„ì‚° (Python ìŠ¤í¬ë¦½íŠ¸)
-- python recalculate_embeddings.py
```

## ğŸ” ê²€ìƒ‰ ìµœì í™”

### SQLite ê²€ìƒ‰ ì¿¼ë¦¬
```sql
-- FTS5 + VSS ê²°í•© ê²€ìƒ‰
WITH vector_search AS (
  SELECT memory_id, similarity
  FROM memory_item_vss
  WHERE vss_search(embedding, ?)
  ORDER BY similarity DESC
  LIMIT 50
),
text_search AS (
  SELECT rowid, rank
  FROM memory_item_fts
  WHERE memory_item_fts MATCH ?
  ORDER BY rank
  LIMIT 50
)
SELECT mi.*, 
       COALESCE(vs.similarity, 0) as vector_score,
       COALESCE(ts.rank, 0) as text_score
FROM memory_item mi
LEFT JOIN vector_search vs ON mi.id = vs.memory_id
LEFT JOIN text_search ts ON mi.rowid = ts.rowid
WHERE vs.memory_id IS NOT NULL OR ts.rowid IS NOT NULL
ORDER BY (vector_score + text_score) DESC;
```

### PostgreSQL ê²€ìƒ‰ ì¿¼ë¦¬
```sql
-- pgvector + tsvector ê²°í•© ê²€ìƒ‰
WITH vector_search AS (
  SELECT id, 1 - (embedding <=> ?) as similarity
  FROM memory_embedding
  ORDER BY embedding <=> ?
  LIMIT 50
),
text_search AS (
  SELECT id, ts_rank(content_tsv, plainto_tsquery('english', ?)) as rank
  FROM memory_item
  WHERE content_tsv @@ plainto_tsquery('english', ?)
  ORDER BY rank DESC
  LIMIT 50
)
SELECT mi.*,
       COALESCE(vs.similarity, 0) as vector_score,
       COALESCE(ts.rank, 0) as text_score
FROM memory_item mi
LEFT JOIN vector_search vs ON mi.id = vs.id
LEFT JOIN text_search ts ON mi.id = ts.id
WHERE vs.id IS NOT NULL OR ts.id IS NOT NULL
ORDER BY (vector_score + text_score) DESC;
```

## ğŸ§¹ ë°ì´í„° ì •ë¦¬ ì •ì±…

### ë§ê° ì •ì±… êµ¬í˜„
```sql
-- ì†Œí”„íŠ¸ ì‚­ì œ í›„ë³´ ì„ ì •
CREATE VIEW forget_candidates AS
SELECT id, type, created_at, last_accessed, importance, pinned,
       CASE 
         WHEN type = 'working' AND created_at < now() - interval '2 days' THEN true
         WHEN type = 'episodic' AND created_at < now() - interval '90 days' THEN true
         ELSE false
       END as should_forget
FROM memory_item
WHERE pinned = false
  AND (type = 'working' OR type = 'episodic');

-- í•˜ë“œ ì‚­ì œ ì‹¤í–‰
DELETE FROM memory_item 
WHERE id IN (
  SELECT id FROM forget_candidates 
  WHERE should_forget = true
);
```

### ë°±ì—… ë° ë³µì›
```sql
-- ë°±ì—…
pg_dump -h localhost -U username -d memory_db > backup.sql

-- ë³µì›
psql -h localhost -U username -d memory_db < backup.sql
```
 
 